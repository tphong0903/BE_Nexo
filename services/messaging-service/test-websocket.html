<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nexo Chat - Messaging Service Tester</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      :root {
        --primary-color: #667eea;
        --primary-dark: #5568d3;
        --success-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-bg: #f8f9fa;
        --border-color: #e0e0e0;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow-lg);
        overflow: hidden;
        display: grid;
        grid-template-rows: auto auto 1fr;
        height: calc(100vh - 40px);
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left h1 {
        font-size: 24px;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-left p {
        font-size: 14px;
        opacity: 0.9;
      }

      .header-right {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .connection-panel {
        padding: 20px 30px;
        background: var(--light-bg);
        border-bottom: 2px solid var(--border-color);
      }

      .connection-grid {
        display: grid;
        grid-template-columns: 2fr 3fr 1fr;
        gap: 15px;
        align-items: end;
      }

      .form-group {
        display: flex;
        flex-direction: column;
      }

      .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
        font-size: 13px;
      }

      .form-group input,
      .form-group select {
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
      }

      .btn-connect {
        background: var(--success-color);
        color: white;
      }

      .btn-connect:hover:not(:disabled) {
        background: #218838;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .btn-disconnect {
        background: var(--danger-color);
        color: white;
      }

      .btn-disconnect:hover:not(:disabled) {
        background: #c82333;
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #5a6268;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status.connected {
        background: #d4edda;
        color: #155724;
      }

      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .main-content {
        display: flex;
        gap: 0;
        overflow: hidden;
        min-height: 500px;
        height: 100%;
        background: #f0f0f0;
      }

      .conversations-sidebar {
        background: #fafbfc;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        width: 300px;
        flex-shrink: 0;
      }

      .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .sidebar-header h2 {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
      }

      .search-box {
        position: relative;
      }

      .search-box input {
        width: 100%;
        padding: 8px 12px 8px 35px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        font-size: 13px;
      }

      .search-box::before {
        content: "üîç";
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
      }

      .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
      }

      .conversation-item {
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 5px;
        border: 2px solid transparent;
      }

      .conversation-item:hover {
        background: #e9ecef;
      }

      .conversation-item.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-dark);
      }

      .conversation-item h4 {
        font-size: 14px;
        margin-bottom: 4px;
      }

      .conversation-item p {
        font-size: 12px;
        opacity: 0.7;
      }

      .chat-area {
        display: flex;
        flex-direction: column;
        background: white;
        flex: 1;
        min-width: 0;
      }

      .chat-header {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-header h2 {
        font-size: 18px;
        color: #333;
      }

      .chat-header-actions {
        display: flex;
        gap: 10px;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(180deg, #fafbfc 0%, #f5f6f7 100%);
        scroll-behavior: smooth;
      }

      .message-bubble {
        max-width: 70%;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        position: relative;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message-bubble.sent {
        align-self: flex-end;
        align-items: flex-end;
      }

      .message-bubble.received {
        align-self: flex-start;
        align-items: flex-start;
      }

      .message-wrapper {
        position: relative;
        display: flex;
        align-items: flex-end;
        gap: 8px;
      }

      .message-bubble.sent .message-wrapper {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
      }

      .message-avatar-placeholder {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
      }

      .message-content-wrapper {
        position: relative;
        max-width: 100%;
      }

      .message-reply-to {
        background: rgba(0, 0, 0, 0.05);
        padding: 6px 10px;
        border-radius: 8px;
        margin-bottom: 6px;
        font-size: 12px;
        border-left: 3px solid var(--primary-color);
      }

      .message-reply-to-author {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 2px;
      }

      .message-reply-to-text {
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .message-content {
        background: white;
        padding: 10px 14px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        word-wrap: break-word;
        position: relative;
        transition: all 0.2s;
      }

      .message-content:hover {
        transform: scale(1.02);
      }

      .message-bubble.sent .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .message-bubble.sent .message-reply-to {
        background: rgba(255, 255, 255, 0.2);
        border-left-color: white;
      }

      .message-bubble.sent .message-reply-to-author {
        color: white;
      }

      .message-bubble.sent .message-reply-to-text {
        color: rgba(255, 255, 255, 0.9);
      }

      .message-bubble.received .message-content {
        background: white;
        color: #333;
        border-bottom-left-radius: 4px;
      }

      .message-actions {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        display: none;
        gap: 4px;
        background: white;
        border-radius: 20px;
        padding: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .message-bubble.sent .message-actions {
        left: -120px;
      }

      .message-bubble.received .message-actions {
        right: -120px;
      }

      .message-bubble:hover .message-actions {
        display: flex;
      }

      .message-action-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: transparent;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        transition: all 0.2s;
      }

      .message-action-btn:hover {
        background: var(--light-bg);
        transform: scale(1.1);
      }

      .message-reactions {
        display: flex;
        gap: 4px;
        margin-top: 4px;
        flex-wrap: wrap;
      }

      .reaction-item {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .reaction-item:hover {
        transform: scale(1.1);
        box-shadow: var(--shadow);
      }

      .reaction-item.my-reaction {
        background: #e3f2fd;
        border-color: var(--primary-color);
      }

      .reaction-item:hover .reaction-remove-btn {
        display: inline-block !important;
      }

      .reaction-emoji {
        font-size: 14px;
      }

      .reaction-count {
        font-size: 11px;
        font-weight: 600;
        color: #666;
      }

      .reaction-picker {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 24px;
        padding: 8px 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        display: none;
        gap: 8px;
        margin-bottom: 8px;
        z-index: 1000;
      }

      .reaction-picker.show {
        display: flex;
      }

      .reaction-picker-emoji {
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 4px;
      }

      .reaction-picker-emoji:hover {
        transform: scale(1.3);
      }

      .message-meta {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .message-type-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
        background: rgba(0, 0, 0, 0.1);
      }

      .reply-preview {
        background: rgba(102, 126, 234, 0.1);
        border-left: 3px solid var(--primary-color);
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        display: none;
      }

      .reply-preview.show {
        display: block;
      }

      .reply-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .reply-preview-author {
        font-weight: 600;
        font-size: 12px;
        color: var(--primary-color);
      }

      .reply-preview-close {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: #999;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .reply-preview-text {
        font-size: 13px;
        color: #666;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .typing-indicator {
        padding: 10px 20px;
        font-size: 13px;
        color: #666;
        font-style: italic;
        background: rgba(102, 126, 234, 0.05);
        border-top: 1px solid var(--border-color);
      }

      .message-input-area {
        padding: 20px;
        border-top: 1px solid var(--border-color);
        background: white;
      }

      .message-input-container {
        display: flex;
        gap: 10px;
        align-items: flex-end;
      }

      .message-input-wrapper {
        flex: 1;
        position: relative;
      }

      .message-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 24px;
        font-size: 14px;
        resize: none;
        max-height: 120px;
        font-family: inherit;
      }

      .message-input:focus {
        outline: none;
        border-color: var(--primary-color);
      }

      .input-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .info-panel {
        background: #fafbfc;
        border-left: 1px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
        width: 350px;
        flex-shrink: 0;
      }

      .panel-section {
        margin-bottom: 25px;
      }

      .panel-section h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logs-container {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 12px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .log-item {
        padding: 6px 8px;
        margin-bottom: 4px;
        border-radius: 4px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }

      .log-item.info {
        color: #3498db;
      }

      .log-item.success {
        color: #2ecc71;
      }

      .log-item.error {
        color: #e74c3c;
      }

      .log-item.warning {
        color: #f39c12;
      }

      .log-time {
        color: #95a5a6;
        flex-shrink: 0;
      }

      .api-endpoints {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
      }

      .api-endpoint {
        margin-bottom: 12px;
        padding: 10px;
        background: var(--light-bg);
        border-radius: 6px;
      }

      .api-method {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        margin-right: 8px;
      }

      .api-method.post {
        background: #49cc90;
        color: white;
      }

      .api-method.get {
        background: #61affe;
        color: white;
      }

      .api-method.delete {
        background: #f93e3e;
        color: white;
      }

      .api-method.put {
        background: #fca130;
        color: white;
      }

      .api-path {
        font-family: "Courier New", monospace;
        font-size: 12px;
        color: #333;
      }

      .api-desc {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .quick-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 15px;
      }

      .quick-action-btn {
        padding: 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <h1>ÔøΩ Nexo Chat Tester</h1>
          <p>Messaging Service WebSocket & REST API Testing Tool</p>
        </div>
        <div class="header-right">
          <span id="statusDisplay" class="status disconnected">
            <span class="status-indicator"></span>
            Ch∆∞a k·∫øt n·ªëi
          </span>
        </div>
      </div>

      <!-- Connection Panel -->
      <div class="connection-panel">
        <div class="connection-grid">
          <div class="form-group">
            <label>üîó WebSocket URL</label>
            <input
              type="text"
              id="wsUrl"
              value="http://localhost:8080/messaging/ws"
              placeholder="http://localhost:8080/messaging/ws"
            />
          </div>
          <div class="form-group">
            <label>üîë JWT Bearer Token</label>
            <input
              type="password"
              id="token"
              placeholder="Nh·∫≠p JWT token t·ª´ Auth Service"
            />
          </div>
          <div class="form-group">
            <label>&nbsp;</label>
            <div style="display: flex; gap: 10px">
              <button
                class="btn btn-connect"
                id="connectBtn"
                onclick="connect()"
                style="flex: 1"
              >
                üîå K·∫øt n·ªëi
              </button>
              <button
                class="btn btn-disconnect"
                id="disconnectBtn"
                onclick="disconnect()"
                disabled
                style="flex: 1"
              >
                ‚ö° Ng·∫Øt
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Conversations Sidebar -->
        <div class="conversations-sidebar">
          <div class="sidebar-header">
            <h2>üí¨ Conversations</h2>
            <div class="search-box">
              <input
                type="text"
                id="conversationSearch"
                placeholder="T√¨m ki·∫øm cu·ªôc tr√≤ chuy·ªán..."
                onkeyup="filterConversations()"
              />
            </div>
            <div class="quick-actions">
              <button
                class="btn btn-primary quick-action-btn"
                onclick="loadConversations()"
                id="loadConversationsBtn"
                disabled
              >
                üìã Load Conversations
              </button>
              <button
                class="btn btn-secondary quick-action-btn"
                onclick="createNewConversation()"
                id="createConvBtn"
                disabled
              >
                ‚ûï New Chat
              </button>
            </div>
          </div>
          <div class="conversations-list" id="conversationsList">
            <div class="empty-state">
              <div class="empty-state-icon">üí¨</div>
              <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>
              <p style="font-size: 12px; margin-top: 8px">
                K·∫øt n·ªëi ƒë·ªÉ t·∫£i danh s√°ch
              </p>
            </div>
          </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
          <div class="chat-header">
            <div>
              <h2 id="chatTitle">Ch·ªçn cu·ªôc tr√≤ chuy·ªán</h2>
              <p id="chatSubtitle" style="font-size: 12px; color: #666"></p>
            </div>
            <div class="chat-header-actions">
              <button
                class="btn btn-secondary"
                onclick="loadMessages()"
                id="loadMessagesBtn"
                disabled
                style="font-size: 12px; padding: 6px 12px"
              >
                üîÑ T·∫£i tin nh·∫Øn
              </button>
              <button
                class="btn btn-secondary"
                onclick="markAsRead()"
                id="markReadBtn"
                disabled
                style="font-size: 12px; padding: 6px 12px"
              >
                ‚úì‚úì ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc
              </button>
            </div>
          </div>

          <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
              <div class="empty-state-icon">üí≠</div>
              <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
              <p style="font-size: 12px; margin-top: 8px">
                Ch·ªçn cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu
              </p>
            </div>
          </div>

          <div
            class="typing-indicator"
            id="typingIndicator"
            style="display: none"
          >
            ƒêang nh·∫≠p...
          </div>

          <div class="message-input-area">
            <!-- Reply Preview -->
            <div class="reply-preview" id="replyPreview">
              <div class="reply-preview-header">
                <span class="reply-preview-author" id="replyPreviewAuthor"
                  >Replying to User</span
                >
                <button class="reply-preview-close" onclick="cancelReply()">
                  √ó
                </button>
              </div>
              <div class="reply-preview-text" id="replyPreviewText">
                Message content...
              </div>
            </div>

            <div class="message-input-container">
              <div class="message-input-wrapper">
                <textarea
                  id="messageInput"
                  class="message-input"
                  placeholder="Nh·∫≠p tin nh·∫Øn..."
                  rows="1"
                  onkeydown="handleKeyDown(event)"
                  oninput="handleTyping(); autoResize(this)"
                  disabled
                ></textarea>
              </div>
              <button
                class="btn btn-primary"
                onclick="sendMessage()"
                id="sendMessageBtn"
                disabled
              >
                üì®
              </button>
            </div>
            <div class="input-actions">
              <select
                id="messageTypeSelect"
                style="
                  padding: 6px;
                  border-radius: 6px;
                  border: 1px solid #e0e0e0;
                  font-size: 12px;
                "
              >
                <option value="TEXT">üìù Text</option>
                <option value="IMAGE">üñºÔ∏è Image</option>
                <option value="VIDEO">üé• Video</option>
                <option value="AUDIO">üéµ Audio</option>
                <option value="FILE">üìé File</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Info Panel -->
        <div class="info-panel">
          <div class="panel-section">
            <h3>üìä API Endpoints</h3>
            <div class="api-endpoints">
              <div class="api-endpoint">
                <div>
                  <span class="api-method post">POST</span>
                  <span class="api-path">/app/chat.send</span>
                </div>
                <div class="api-desc">G·ª≠i tin nh·∫Øn qua WebSocket</div>
              </div>
              <div class="api-endpoint">
                <div>
                  <span class="api-method post">POST</span>
                  <span class="api-path">/app/chat.typing</span>
                </div>
                <div class="api-desc">Th√¥ng b√°o ƒëang nh·∫≠p</div>
              </div>
              <div class="api-endpoint">
                <div>
                  <span class="api-method post">POST</span>
                  <span class="api-path">/app/chat.read</span>
                </div>
                <div class="api-desc">ƒê√°nh d·∫•u tin nh·∫Øn ƒë√£ ƒë·ªçc</div>
              </div>
              <div class="api-endpoint">
                <div>
                  <span class="api-method get">GET</span>
                  <span class="api-path">/api/messages</span>
                </div>
                <div class="api-desc">L·∫•y danh s√°ch tin nh·∫Øn</div>
              </div>
              <div class="api-endpoint">
                <div>
                  <span class="api-method get">GET</span>
                  <span class="api-path">/api/conversations</span>
                </div>
                <div class="api-desc">L·∫•y danh s√°ch cu·ªôc tr√≤ chuy·ªán</div>
              </div>
              <div class="api-endpoint">
                <div>
                  <span class="api-method post">POST</span>
                  <span class="api-path">/api/messages/{id}/reactions</span>
                </div>
                <div class="api-desc">Th√™m reaction v√†o tin nh·∫Øn</div>
              </div>
            </div>
          </div>

          <div class="panel-section">
            <h3>üìã Activity Logs</h3>
            <div class="logs-container" id="logsContainer"></div>
            <button
              class="btn btn-secondary"
              onclick="clearLogs()"
              style="width: 100%; margin-top: 10px; font-size: 12px"
            >
              üóëÔ∏è X√≥a logs
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let stompClient = null;
      let currentConversationId = null;
      let currentToken = null;
      let conversations = [];
      let messages = [];
      let typingTimeout = null;
      const API_BASE_URL = "http://localhost:8080/api";

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        addLog("üöÄ ·ª®ng d·ª•ng ƒë√£ kh·ªüi ƒë·ªông", "info");
        addLog("üìå Nh·∫≠p JWT Token v√† nh·∫•n K·∫øt n·ªëi ƒë·ªÉ b·∫Øt ƒë·∫ßu", "info");
      });

      // ==================== LOGGING ====================
      function addLog(message, type = "info") {
        const logs = document.getElementById("logsContainer");
        const logItem = document.createElement("div");
        logItem.className = `log-item ${type}`;
        const time = new Date().toLocaleTimeString("vi-VN");

        const icon = {
          info: "‚ÑπÔ∏è",
          success: "‚úÖ",
          error: "‚ùå",
          warning: "‚ö†Ô∏è",
        }[type];

        logItem.innerHTML = `
          <span class="log-time">${time}</span>
          <span>${icon} ${message}</span>
        `;
        logs.appendChild(logItem);
        logs.scrollTop = logs.scrollHeight;
      }

      function clearLogs() {
        document.getElementById("logsContainer").innerHTML = "";
        addLog("üóëÔ∏è ƒê√£ x√≥a logs", "info");
      }

      // ==================== WEBSOCKET CONNECTION ====================
      function connect() {
        const wsUrl = document.getElementById("wsUrl").value;
        const token = document.getElementById("token").value;

        if (!token) {
          addLog("Vui l√≤ng nh·∫≠p Bearer Token!", "error");
          alert("Vui l√≤ng nh·∫≠p Bearer Token!");
          return;
        }

        currentToken = token;
        addLog(`üîÑ ƒêang k·∫øt n·ªëi ƒë·∫øn ${wsUrl}...`, "info");

        const socket = new SockJS(wsUrl);
        stompClient = Stomp.over(socket);

        stompClient.debug = (str) => console.log(str);

        const headers = {
          Authorization: `Bearer ${token}`,
        };

        stompClient.connect(
          headers,
          function (frame) {
            addLog("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng!", "success");
            updateConnectionStatus(true);

            // Subscribe to user-specific errors
            stompClient.subscribe(
              "/user/queue/errors",
              function (message) {
                const error = JSON.parse(message.body);
                addLog(`L·ªói: ${error.message}`, "error");
              },
              headers
            );

            addLog("‚úÖ ƒê√£ subscribe v√†o /user/queue/errors", "success");
          },
          function (error) {
            addLog(`L·ªói k·∫øt n·ªëi: ${error}`, "error");
            updateConnectionStatus(false);
          }
        );
      }

      function disconnect() {
        if (stompClient !== null) {
          stompClient.disconnect();
          addLog("‚ö° ƒê√£ ng·∫Øt k·∫øt n·ªëi WebSocket", "info");
        }
        updateConnectionStatus(false);
        currentConversationId = null;
      }

      function updateConnectionStatus(connected) {
        const status = document.getElementById("statusDisplay");
        const connectBtn = document.getElementById("connectBtn");
        const disconnectBtn = document.getElementById("disconnectBtn");
        const loadConversationsBtn = document.getElementById(
          "loadConversationsBtn"
        );
        const createConvBtn = document.getElementById("createConvBtn");

        if (connected) {
          status.innerHTML =
            '<span class="status-indicator"></span> ƒê√£ k·∫øt n·ªëi';
          status.className = "status connected";
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          loadConversationsBtn.disabled = false;
          createConvBtn.disabled = false;
        } else {
          status.innerHTML =
            '<span class="status-indicator"></span> Ch∆∞a k·∫øt n·ªëi';
          status.className = "status disconnected";
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          loadConversationsBtn.disabled = true;
          createConvBtn.disabled = true;
          document.getElementById("messageInput").disabled = true;
          document.getElementById("sendMessageBtn").disabled = true;
          document.getElementById("loadMessagesBtn").disabled = true;
          document.getElementById("markReadBtn").disabled = true;
        }
      }

      // ==================== CONVERSATIONS ====================
      async function loadConversations() {
        if (!currentToken) {
          addLog("Ch∆∞a c√≥ token!", "error");
          return;
        }

        try {
          addLog("üîÑ ƒêang t·∫£i danh s√°ch cu·ªôc tr√≤ chuy·ªán...", "info");

          const response = await axios.get(`${API_BASE_URL}/conversations`, {
            headers: {
              Authorization: `Bearer ${currentToken}`,
            },
            params: {
              page: 0,
              size: 50,
            },
          });

          if (response.data && response.data.data) {
            conversations = response.data.data.content || [];
            displayConversations(conversations);
            addLog(
              `‚úÖ ƒê√£ t·∫£i ${conversations.length} cu·ªôc tr√≤ chuy·ªán`,
              "success"
            );
          }
        } catch (error) {
          addLog(
            `‚ùå L·ªói khi t·∫£i conversations: ${
              error.response?.data?.message || error.message
            }`,
            "error"
          );
          console.error(error);
        }
      }

      function displayConversations(convs) {
        const listEl = document.getElementById("conversationsList");
        listEl.innerHTML = "";

        if (convs.length === 0) {
          listEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üí¨</div>
              <p>Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o</p>
            </div>
          `;
          return;
        }

        convs.forEach((conv) => {
          const item = document.createElement("div");
          item.className = "conversation-item";
          if (conv.id === currentConversationId) {
            item.classList.add("active");
          }

          // Get conversation name - use name field if available, otherwise get other participant's name
          let conversationName = conv.name || `Conversation #${conv.id}`;

          // If no name, try to get the other participant's name
          if (!conv.name && conv.participants && conv.participants.length > 0) {
            // Assuming we want to show the name of the OTHER person (not current user)
            // You might need to filter out current user if you have that info
            const otherParticipant =
              conv.participants[conv.participants.length - 1];
            conversationName =
              otherParticipant.fullName || otherParticipant.username;
          }

          // Get avatar URL
          let avatarUrl = conv.avatarUrl || "";
          if (!avatarUrl && conv.participants && conv.participants.length > 0) {
            const otherParticipant =
              conv.participants[conv.participants.length - 1];
            avatarUrl = otherParticipant.avatarUrl || "";
          }

          // Handle lastMessage - it could be string, object, or null
          let lastMessageText = "";
          let showLastMessage = false;

          if (conv.lastMessage) {
            showLastMessage = true;
            if (typeof conv.lastMessage === "string") {
              lastMessageText = conv.lastMessage;
            } else if (conv.lastMessage.content) {
              lastMessageText = conv.lastMessage.content;
            } else if (conv.lastMessage.text) {
              lastMessageText = conv.lastMessage.text;
            }
          }

          const displayMessage = showLastMessage
            ? lastMessageText.substring(0, 30) +
              (lastMessageText.length > 30 ? "..." : "")
            : "";

          const time =
            conv.lastMessageAt || conv.updatedAt
              ? new Date(
                  conv.lastMessageAt || conv.updatedAt
                ).toLocaleTimeString("vi-VN", {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "";

          // Build the HTML with avatar if available
          const avatarHtml = avatarUrl
            ? `<img src="${avatarUrl}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; flex-shrink: 0;" onerror="this.style.display='none'">`
            : `<div style="width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; margin-right: 10px; flex-shrink: 0; font-weight: bold;">${conversationName
                .charAt(0)
                .toUpperCase()}</div>`;

          item.innerHTML = `
            <div style="display: flex; align-items: center; width: 100%;">
              ${avatarHtml}
              <div style="flex: 1; min-width: 0;">
                <h4 style="margin: 0; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conversationName}</h4>
                ${
                  showLastMessage
                    ? `<p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${displayMessage}</p>`
                    : '<p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.5; font-style: italic;">Ch∆∞a c√≥ tin nh·∫Øn</p>'
                }
                ${
                  time
                    ? `<p style="margin: 2px 0 0 0; font-size: 10px; opacity: 0.6;">${time}</p>`
                    : ""
                }
              </div>
              ${
                conv.unreadCount > 0
                  ? `<div style="background: var(--danger-color); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; margin-left: 8px;">${conv.unreadCount}</div>`
                  : ""
              }
            </div>
          `;

          item.onclick = () => selectConversation(conv);
          listEl.appendChild(item);
        });
      }

      function selectConversation(conv) {
        currentConversationId = conv.id;
        displayConversations(conversations);

        // Get conversation name
        let conversationName = conv.name || `Conversation #${conv.id}`;
        if (!conv.name && conv.participants && conv.participants.length > 0) {
          const otherParticipant =
            conv.participants[conv.participants.length - 1];
          conversationName =
            otherParticipant.fullName || otherParticipant.username;
        }

        // Get avatar
        let avatarUrl = conv.avatarUrl || "";
        if (!avatarUrl && conv.participants && conv.participants.length > 0) {
          const otherParticipant =
            conv.participants[conv.participants.length - 1];
          avatarUrl = otherParticipant.avatarUrl || "";
        }

        // Update chat header with avatar
        const avatarHtml = avatarUrl
          ? `<img src="${avatarUrl}" alt="avatar" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover; margin-right: 12px;" onerror="this.style.display='none'">`
          : `<div style="width: 36px; height: 36px; border-radius: 50%; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; font-size: 16px;">${conversationName
              .charAt(0)
              .toUpperCase()}</div>`;

        document.getElementById("chatTitle").innerHTML = `
          <div style="display: flex; align-items: center;">
            ${avatarHtml}
            <div>
              <div style="font-size: 18px; font-weight: 600;">${conversationName}</div>
              <div style="font-size: 12px; color: #666; font-weight: normal;">Conversation #${conv.id}</div>
            </div>
          </div>
        `;
        document.getElementById("chatSubtitle").textContent = "";

        document.getElementById("messageInput").disabled = false;
        document.getElementById("sendMessageBtn").disabled = false;
        document.getElementById("loadMessagesBtn").disabled = false;
        document.getElementById("markReadBtn").disabled = false;

        subscribeToConversation(conv.id);
        loadMessages();

        addLog(`üìÇ ƒê√£ ch·ªçn conversation v·ªõi ${conversationName}`, "info");
      }

      function subscribeToConversation(conversationId) {
        if (!stompClient || !stompClient.connected) return;

        const headers = {
          Authorization: `Bearer ${currentToken}`,
        };

        // Subscribe to messages
        stompClient.subscribe(
          `/topic/conversation/${conversationId}`,
          function (message) {
            const msg = JSON.parse(message.body);
            addLog(
              `üì® Nh·∫≠n tin nh·∫Øn m·ªõi t·ª´ conversation #${conversationId}`,
              "success"
            );
            addMessageToUI(msg, false);
          },
          headers
        );

        // Subscribe to typing
        stompClient.subscribe(
          `/topic/conversation/${conversationId}/typing`,
          function (message) {
            const typing = JSON.parse(message.body);
            showTypingIndicator(typing);
          },
          headers
        );

        // Subscribe to read receipts
        stompClient.subscribe(
          `/topic/conversation/${conversationId}/read`,
          function (message) {
            const receipt = JSON.parse(message.body);
            addLog(
              `‚úì‚úì User #${receipt.userId} ƒë√£ ƒë·ªçc tin nh·∫Øn #${receipt.messageId}`,
              "info"
            );
          },
          headers
        );

        addLog(
          `‚úÖ ƒê√£ subscribe v√†o conversation #${conversationId}`,
          "success"
        );
      }

      function filterConversations() {
        const search = document
          .getElementById("conversationSearch")
          .value.toLowerCase();
        const filtered = conversations.filter(
          (c) =>
            c.id.toString().includes(search) ||
            (c.lastMessage && c.lastMessage.toLowerCase().includes(search))
        );
        displayConversations(filtered);
      }

      async function createNewConversation() {
        const recipientId = prompt("Nh·∫≠p User ID c·ªßa ng∆∞·ªùi nh·∫≠n:");
        if (!recipientId) return;

        try {
          addLog(
            `üîÑ ƒêang t·∫°o conversation v·ªõi user #${recipientId}...`,
            "info"
          );

          const response = await axios.get(
            `${API_BASE_URL}/conversations/${recipientId}`,
            {
              headers: {
                Authorization: `Bearer ${currentToken}`,
              },
            }
          );

          if (response.data && response.data.data) {
            addLog(`‚úÖ ƒê√£ t·∫°o/l·∫•y conversation th√†nh c√¥ng`, "success");
            loadConversations();
          }
        } catch (error) {
          addLog(
            `‚ùå L·ªói khi t·∫°o conversation: ${
              error.response?.data?.message || error.message
            }`,
            "error"
          );
        }
      }

      // ==================== MESSAGES ====================
      async function loadMessages() {
        if (!currentConversationId || !currentToken) {
          addLog("Ch∆∞a ch·ªçn conversation!", "warning");
          return;
        }

        try {
          addLog(
            `üîÑ ƒêang t·∫£i tin nh·∫Øn t·ª´ conversation #${currentConversationId}...`,
            "info"
          );

          const response = await axios.get(`${API_BASE_URL}/messages`, {
            headers: {
              Authorization: `Bearer ${currentToken}`,
            },
            params: {
              conversationId: currentConversationId,
              page: 0,
              size: 50,
            },
          });

          if (response.data && response.data.data) {
            messages = response.data.data.content || [];
            displayMessages(messages);
            addLog(`‚úÖ ƒê√£ t·∫£i ${messages.length} tin nh·∫Øn`, "success");
          }
        } catch (error) {
          addLog(
            `‚ùå L·ªói khi t·∫£i messages: ${
              error.response?.data?.message || error.message
            }`,
            "error"
          );
          console.error(error);
        }
      }

      function displayMessages(msgs) {
        const container = document.getElementById("messagesContainer");
        container.innerHTML = "";

        if (msgs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üí≠</div>
              <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>
            </div>
          `;
          return;
        }

        msgs.forEach((msg) => addMessageToUI(msg, true));
        container.scrollTop = container.scrollHeight;
      }

      function addMessageToUI(msg, skipScroll = false) {
        const container = document.getElementById("messagesContainer");

        // Remove empty state if exists
        const emptyState = container.querySelector(".empty-state");
        if (emptyState) emptyState.remove();

        const bubble = document.createElement("div");
        bubble.className = `message-bubble ${msg.isSent ? "sent" : "received"}`;
        bubble.setAttribute("data-message-id", msg.id);

        const time = msg.createdAt
          ? new Date(msg.createdAt).toLocaleTimeString("vi-VN", {
              hour: "2-digit",
              minute: "2-digit",
            })
          : new Date().toLocaleTimeString("vi-VN", {
              hour: "2-digit",
              minute: "2-digit",
            });

        // Get sender info
        const senderName =
          msg.sender?.fullName ||
          msg.sender?.username ||
          `User #${msg.senderId}`;
        const senderAvatar = msg.sender?.avatarUrl || "";
        const senderInitial = senderName.charAt(0).toUpperCase();

        // Build reply-to section if exists
        let replyToHtml = "";
        if (msg.replyToMessage) {
          const replyAuthor =
            msg.replyToMessage.sender?.fullName ||
            msg.replyToMessage.sender?.username ||
            "Unknown";
          const replyText = msg.replyToMessage.content || "";
          replyToHtml = `
            <div class="message-reply-to">
              <div class="message-reply-to-author">${replyAuthor}</div>
              <div class="message-reply-to-text">${replyText}</div>
            </div>
          `;
        }

        // Build reactions section
        let reactionsHtml = "";
        if (msg.reactions && msg.reactions.length > 0) {
          const reactionMap = {};
          msg.reactions.forEach((r) => {
            const emoji = getReactionEmoji(r.reactionType);
            if (!reactionMap[emoji]) {
              reactionMap[emoji] = {
                count: 0,
                userIds: [],
                reactionType: r.reactionType,
              };
            }
            reactionMap[emoji].count++;
            reactionMap[emoji].userIds.push(r.userId);
          });

          reactionsHtml = '<div class="message-reactions">';
          Object.entries(reactionMap).forEach(([emoji, data]) => {
            reactionsHtml += `
              <div class="reaction-item" title="Click ƒë·ªÉ x√≥a reaction">
                <span class="reaction-emoji">${emoji}</span>
                <span class="reaction-count">${data.count}</span>
                <button 
                  class="reaction-remove-btn" 
                  onclick="event.stopPropagation(); removeReaction('${emoji}', ${msg.id})"
                  title="X√≥a reaction"
                  style="display: none; margin-left: 4px; background: rgba(0,0,0,0.1); border: none; border-radius: 50%; width: 16px; height: 16px; cursor: pointer; font-size: 10px; padding: 0; line-height: 1;">
                  √ó
                </button>
              </div>
            `;
          });
          reactionsHtml += "</div>";
        }

        // Build avatar
        const avatarHtml = !msg.isSent
          ? senderAvatar
            ? `<img src="${senderAvatar}" class="message-avatar" onerror="this.style.display='none'" alt="avatar">`
            : `<div class="message-avatar-placeholder">${senderInitial}</div>`
          : "";

        bubble.innerHTML = `
          <div class="message-wrapper">
            ${avatarHtml}
            <div class="message-content-wrapper">
              ${replyToHtml}
              <div class="message-content">
                ${msg.content || msg.text || ""}
                <div class="reaction-picker" id="reactionPicker${msg.id}">
                  <span class="reaction-picker-emoji" onclick="addReaction('‚ù§Ô∏è', ${
                    msg.id
                  })">‚ù§Ô∏è</span>
                  <span class="reaction-picker-emoji" onclick="addReaction('üòÇ', ${
                    msg.id
                  })">üòÇ</span>
                  <span class="reaction-picker-emoji" onclick="addReaction('üòÆ', ${
                    msg.id
                  })">üòÆ</span>
                  <span class="reaction-picker-emoji" onclick="addReaction('üò¢', ${
                    msg.id
                  })">üò¢</span>
                  <span class="reaction-picker-emoji" onclick="addReaction('üëç', ${
                    msg.id
                  })">üëç</span>
                  <span class="reaction-picker-emoji" onclick="addReaction('üî•', ${
                    msg.id
                  })">üî•</span>
                </div>
              </div>
              ${reactionsHtml}
              <div class="message-actions">
                <button class="message-action-btn" onclick="showReactionPicker(${
                  msg.id
                })" title="React">
                  ‚ù§Ô∏è
                </button>
                <button class="message-action-btn" onclick="replyToMessage(${
                  msg.id
                }, '${senderName}', '${(msg.content || "").replace(
          /'/g,
          "\\'"
        )}' )" title="Reply">
                  ‚Ü©Ô∏è
                </button>
                <button class="message-action-btn" onclick="copyMessage('${(
                  msg.content || ""
                ).replace(/'/g, "\\'")}' )" title="Copy">
                  üìã
                </button>
              </div>
            </div>
          </div>
          <div class="message-meta">
            <span>${time}</span>
            ${msg.id ? `<span>#${msg.id}</span>` : ""}
          </div>
        `;

        container.appendChild(bubble);

        if (!skipScroll) {
          container.scrollTop = container.scrollHeight;
        }
      }

      function getReactionEmoji(reactionType) {
        const emojiMap = {
          LIKE: "üëç",
          LOVE: "‚ù§Ô∏è",
          HAHA: "üòÇ",
          WOW: "üòÆ",
          SAD: "üò¢",
          ANGRY: "üò°",
          FIRE: "üî•",
        };
        return emojiMap[reactionType] || "üëç";
      }

      function showReactionPicker(messageId) {
        // Hide all other pickers
        document.querySelectorAll(".reaction-picker").forEach((p) => {
          p.classList.remove("show");
        });

        // Show this picker
        const picker = document.getElementById(`reactionPicker${messageId}`);
        if (picker) {
          picker.classList.toggle("show");

          // Hide after 5 seconds
          setTimeout(() => {
            picker.classList.remove("show");
          }, 5000);
        }
      }

      async function addReaction(emoji, messageId) {
        if (!currentToken) {
          addLog("Ch∆∞a ƒëƒÉng nh·∫≠p!", "error");
          return;
        }

        // Hide reaction picker
        const picker = document.getElementById(`reactionPicker${messageId}`);
        if (picker) picker.classList.remove("show");

        try {
          const reactionTypeMap = {
            "‚ù§Ô∏è": "LOVE",
            "üòÇ": "LAUGH",
            "üòÆ": "WOW",
            "üò¢": "SAD",
            "üëç": "LIKE",
            "üî•": "FIRE",
            "üò°": "ANGRY",
          };

          const reactionType = reactionTypeMap[emoji] || "LIKE";

          await axios.post(
            `${API_BASE_URL}/messages/${messageId}/reactions`,
            { reactionType: reactionType },
            {
              headers: {
                Authorization: `Bearer ${currentToken}`,
              },
            }
          );

          addLog(
            `‚úÖ ƒê√£ th√™m reaction ${emoji} v√†o tin nh·∫Øn #${messageId}`,
            "success"
          );

          // Reload messages to update UI
          loadMessages();
        } catch (error) {
          addLog(
            `‚ùå L·ªói th√™m reaction: ${
              error.response?.data?.message || error.message
            }`,
            "error"
          );
        }
      }

      async function removeReaction(emoji, messageId) {
        if (!currentToken) {
          addLog("Ch∆∞a ƒëƒÉng nh·∫≠p!", "error");
          return;
        }

        try {
          const reactionTypeMap = {
            "‚ù§Ô∏è": "LOVE",
            "üòÇ": "LAUGH",
            "üòÆ": "WOW",
            "üò¢": "SAD",
            "üëç": "LIKE",
            "üî•": "FIRE",
            "üò°": "ANGRY",
          };

          const reactionType = reactionTypeMap[emoji] || "LIKE";

          await axios.delete(
            `${API_BASE_URL}/messages/${messageId}/reactions`,
            {
              headers: {
                Authorization: `Bearer ${currentToken}`,
              },
              params: {
                reactionType: reactionType,
              },
            }
          );

          addLog(
            `‚úÖ ƒê√£ x√≥a reaction ${emoji} kh·ªèi tin nh·∫Øn #${messageId}`,
            "success"
          );

          // Reload messages to update UI
          loadMessages();
        } catch (error) {
          addLog(
            `‚ùå L·ªói x√≥a reaction: ${
              error.response?.data?.message || error.message
            }`,
            "error"
          );
        }
      }

      function toggleReaction(emoji, messageId) {
        // For now, just add reaction. Could check if user already reacted and remove instead
        addReaction(emoji, messageId);
      }

      let replyingToMessage = null;

      function replyToMessage(messageId, senderName, content) {
        replyingToMessage = {
          id: messageId,
          author: senderName,
          content: content,
        };

        document.getElementById(
          "replyPreviewAuthor"
        ).textContent = `Replying to ${senderName}`;
        document.getElementById("replyPreviewText").textContent = content;
        document.getElementById("replyPreview").classList.add("show");

        // Focus on input
        document.getElementById("messageInput").focus();

        addLog(
          `‚Ü©Ô∏è ƒêang tr·∫£ l·ªùi tin nh·∫Øn #${messageId} c·ªßa ${senderName}`,
          "info"
        );
      }

      function cancelReply() {
        replyingToMessage = null;
        document.getElementById("replyPreview").classList.remove("show");
      }

      function copyMessage(content) {
        navigator.clipboard.writeText(content).then(() => {
          addLog("üìã ƒê√£ copy tin nh·∫Øn", "success");
        });
      }

      function autoResize(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + "px";
      }

      function sendMessage() {
        if (!stompClient || !stompClient.connected) {
          addLog("Ch∆∞a k·∫øt n·ªëi WebSocket!", "error");
          return;
        }

        if (!currentConversationId) {
          addLog("Ch∆∞a ch·ªçn conversation!", "error");
          return;
        }

        const content = document.getElementById("messageInput").value.trim();
        if (!content) {
          addLog("N·ªôi dung tin nh·∫Øn kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!", "warning");
          return;
        }

        const messageType = document.getElementById("messageTypeSelect").value;

        const message = {
          conversationId: currentConversationId,
          content: content,
          messageType: messageType,
          replyToMessageId: replyingToMessage ? replyingToMessage.id : null,
        };

        const headers = {
          Authorization: `Bearer ${currentToken}`,
        };

        try {
          stompClient.send("/app/chat.send", headers, JSON.stringify(message));
          addLog(
            `‚úÖ ƒê√£ g·ª≠i tin nh·∫Øn: "${content.substring(0, 30)}..."`,
            "success"
          );

          // Clear input
          document.getElementById("messageInput").value = "";
          document.getElementById("messageInput").style.height = "auto";
          cancelReply(); // Clear reply preview
        } catch (error) {
          addLog(`‚ùå L·ªói g·ª≠i tin nh·∫Øn: ${error}`, "error");
        }
      }

      function handleKeyDown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendMessage();
        }
      }

      function handleTyping() {
        if (!stompClient || !stompClient.connected || !currentConversationId)
          return;

        clearTimeout(typingTimeout);

        const notification = {
          conversationId: currentConversationId,
        };

        const headers = {
          Authorization: `Bearer ${currentToken}`,
        };

        stompClient.send(
          "/app/chat.typing",
          headers,
          JSON.stringify(notification)
        );

        typingTimeout = setTimeout(() => {
          hideTypingIndicator();
        }, 3000);
      }

      function showTypingIndicator(typing) {
        const indicator = document.getElementById("typingIndicator");
        indicator.textContent = `${
          typing.username || "User #" + typing.userId
        } ƒëang nh·∫≠p...`;
        indicator.style.display = "block";

        setTimeout(() => {
          hideTypingIndicator();
        }, 3000);
      }

      function hideTypingIndicator() {
        document.getElementById("typingIndicator").style.display = "none";
      }

      function markAsRead() {
        if (!stompClient || !stompClient.connected || !currentConversationId) {
          addLog("Kh√¥ng th·ªÉ ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc!", "warning");
          return;
        }

        const request = {
          conversationId: currentConversationId,
        };

        const headers = {
          Authorization: `Bearer ${currentToken}`,
        };

        try {
          stompClient.send(
            "/app/chat.read-conversation",
            headers,
            JSON.stringify(request)
          );
          addLog(
            `‚úÖ ƒê√£ ƒë√°nh d·∫•u conversation #${currentConversationId} l√† ƒë√£ ƒë·ªçc`,
            "success"
          );
        } catch (error) {
          addLog(`‚ùå L·ªói ƒë√°nh d·∫•u ƒë√£ ƒë·ªçc: ${error}`, "error");
        }
      }

      // Clean up on page unload
      window.addEventListener("beforeunload", function () {
        if (stompClient !== null) {
          disconnect();
        }
      });
    </script>
  </body>
</html>
